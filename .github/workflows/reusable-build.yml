name: reusable-build

on:
  workflow_call:
    inputs:
      manifest_repo:
        required: true
        type: string
        description: GitHub slug for the brand manifest repo (e.g., frinsan/app-sample)
      manifest_ref:
        required: false
        default: main
        type: string
        description: Git ref in the manifest repo
      manifest_path:
        required: false
        default: app.json
        type: string
        description: Path to the manifest JSON inside the brand repo
      scheme:
        required: false
        default: TemplateApp
        type: string
      configuration:
        required: false
        default: Release
        type: string
      run_tests:
        required: false
        default: true
        type: boolean
      perform_signing:
        required: false
        default: false
        type: boolean
        description: Set true to import certs/profiles and produce a signed archive
      provisioning_profile_name:
        required: false
        default: TemplateApp-AppStore
        type: string
      code_sign_identity:
        required: false
        default: Apple Distribution
        type: string
      upload_to_testflight:
        required: false
        default: false
        type: boolean
        description: Requires perform_signing + App Store Connect API secrets
      xcode_version:
        required: false
        default: "26.0"
        type: string
        description: Xcode version to use for builds (e.g., 26.0)
    secrets:
      APPLE_CERTIFICATE:
        required: false
      APPLE_CERTIFICATE_PASSWORD:
        required: false
      APPLE_PROVISIONING_PROFILE:
        required: false
      APPLE_TEAM_ID:
        required: false
      APP_STORE_CONNECT_KEY_ID:
        required: false
      APP_STORE_CONNECT_ISSUER_ID:
        required: false
      APP_STORE_CONNECT_PRIVATE_KEY:
        required: false

env:
  XCODE_PROJECT: TemplateApp.xcodeproj

jobs:
  build-and-archive:
    runs-on: macos-latest
    steps:
      - name: Checkout template
        uses: actions/checkout@v4
        with:
          repository: frinsan/ios-app-template

      - name: Checkout brand manifest
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.manifest_repo }}
          ref: ${{ inputs.manifest_ref }}
          path: __brand

      - name: Validate manifest JSON
        run: jq . "__brand/${{ inputs.manifest_path }}"

      - name: Apply brand overlay (if present)
        run: |
          if [ -d "__brand/Overlay/TemplateApp" ]; then
            echo "Applying brand overlay from __brand/Overlay/TemplateApp"
            rsync -a __brand/Overlay/TemplateApp/ TemplateApp/
          else
            echo "No brand overlay found; skipping."
          fi

      - name: Apply manifest
        run: ./scripts/apply_manifest.sh "__brand/${{ inputs.manifest_path }}"

      - name: Show applied manifest
        run: cat TemplateApp/TemplateApp/Config/app.json

      - name: Set up Xcode (prefer requested, fallback to latest)
        run: |
          set -euo pipefail
          echo "Attempting Xcode ${{ inputs.xcode_version }}..."
          if ! sudo xcode-select -s "/Applications/Xcode_${{ inputs.xcode_version }}.app/Contents/Developer"; then
            echo "Xcode ${{ inputs.xcode_version }} not found; falling back to latest."
            /bin/ls -1 /Applications | grep -E '^Xcode_.*\\.app$' || true
            LATEST_XCODE="$(/bin/ls -1 /Applications | grep -E '^Xcode_.*\\.app$' | sort -V | tail -n 1 || true)"
            if [[ -n "$LATEST_XCODE" ]]; then
              sudo xcode-select -s "/Applications/${LATEST_XCODE}/Contents/Developer"
            else
              echo "No Xcode_*.app found; using system default."
              sudo xcode-select -s "/Applications/Xcode.app/Contents/Developer"
            fi
          fi

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Set build number
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          xcrun agvtool new-version -all "$BUILD_NUMBER"

      - name: Capture manifest metadata
        id: manifest_meta
        run: |
          APP_ID=$(jq -r '.appId' TemplateApp/TemplateApp/Config/app.json)
          DISPLAY_NAME=$(jq -r '.displayName' TemplateApp/TemplateApp/Config/app.json)
          echo "APP_BUNDLE_ID=$APP_ID" >> "$GITHUB_ENV"
          echo "APP_DISPLAY_NAME=$DISPLAY_NAME" >> "$GITHUB_ENV"

      - name: Select available iOS simulator
        run: |
          set -euo pipefail
          SIM_JSON=$(xcrun simctl list devices available -j)
          RUNTIME_KEYS=$(jq -r '.devices | keys[]' <<<"$SIM_JSON" | grep -E '^com\.apple\.CoreSimulator\.SimRuntime\.iOS-' || true)
          if [[ -z "$RUNTIME_KEYS" ]]; then
            echo "No iOS simulator runtimes found; skipping tests."
            echo "SKIP_TESTS=true" >> "$GITHUB_ENV"
            exit 0
          fi
          LATEST_RUNTIME=$(printf '%s\n' "$RUNTIME_KEYS" | sed -E 's/^com\.apple\.CoreSimulator\.SimRuntime\.//' | sort -V | tail -n 1)
          if [[ -z "$LATEST_RUNTIME" ]]; then
            echo "Unable to determine latest iOS simulator runtime." >&2
            exit 1
          fi
          SELECTED_RUNTIME="com.apple.CoreSimulator.SimRuntime.${LATEST_RUNTIME}"
          OS_VERSION=$(sed -E 's/^iOS-//' <<<"$LATEST_RUNTIME" | tr '-' '.')
          if [[ -z "$OS_VERSION" ]]; then
            echo "Unable to determine simulator OS version." >&2
            exit 1
          fi
          CANDIDATES=()
          while IFS= read -r line; do
            CANDIDATES+=("$line")
          done <<'EOF'
          iPhone 16 Pro Max
          iPhone 16 Pro
          iPhone 16
          iPhone 15 Pro Max
          iPhone 15 Pro
          iPhone 15
          EOF
          SELECTED_UDID=""
          for NAME in "${CANDIDATES[@]}"; do
            UDID=$(jq -r --arg name "$NAME" '
              .devices
              | to_entries[]
              | select(.key == "'"$SELECTED_RUNTIME"'")
              | .value[]
              | select(.name == $name and .isAvailable == true)
              | .udid' <<<"$SIM_JSON" | head -n 1 || true)
            if [[ -n "$UDID" ]]; then
              echo "Using simulator: $NAME ($UDID)"
              echo "SIMULATOR_NAME=$NAME" >> "$GITHUB_ENV"
              echo "SIMULATOR_RUNTIME=$SELECTED_RUNTIME" >> "$GITHUB_ENV"
              SELECTED_UDID="$UDID"
              break
            fi
          done
          if [[ -z "$SELECTED_UDID" ]]; then
            NAME=$(jq -r '
              .devices
              | to_entries[]
              | select(.key == "'"$SELECTED_RUNTIME"'")
              | .value[]
              | select(.isAvailable == true)
              | .name' <<<"$SIM_JSON" | head -n 1 || true)
            UDID=$(jq -r '
              .devices
              | to_entries[]
              | select(.key == "'"$SELECTED_RUNTIME"'")
              | .value[]
              | select(.isAvailable == true)
              | .udid' <<<"$SIM_JSON" | head -n 1 || true)
            if [[ -n "$UDID" && -n "$NAME" ]]; then
              echo "Using fallback simulator: $NAME ($UDID)"
              echo "SIMULATOR_NAME=$NAME" >> "$GITHUB_ENV"
              echo "SIMULATOR_RUNTIME=$SELECTED_RUNTIME" >> "$GITHUB_ENV"
              SELECTED_UDID="$UDID"
            fi
          fi
          if [[ -z "$SELECTED_UDID" ]]; then
            echo "No matching simulator found for runtime ${SELECTED_RUNTIME}." >&2
            exit 1
          fi
          echo "SIMULATOR_OS=$OS_VERSION" >> "$GITHUB_ENV"
          echo "SKIP_TESTS=false" >> "$GITHUB_ENV"

      - name: Run unit tests
        if: inputs.run_tests == true && env.SKIP_TESTS != 'true'
        run: |
          set -o pipefail
          xcodebuild \
            -project "$XCODE_PROJECT" \
            -scheme "${{ inputs.scheme }}" \
            -destination "platform=iOS Simulator,name=${SIMULATOR_NAME},OS=${SIMULATOR_OS}" \
            clean test

      - name: Import signing certificate
        if: inputs.perform_signing == true
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Install provisioning profile
        if: inputs.perform_signing == true
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/${{ inputs.provisioning_profile_name }}.mobileprovision
          if printf '%s' "${{ secrets.APPLE_PROVISIONING_PROFILE }}" | base64 --decode > "$PROFILE_PATH" 2>/dev/null; then
            echo "Decoded provisioning profile from base64."
          else
            printf '%s' "${{ secrets.APPLE_PROVISIONING_PROFILE }}" > "$PROFILE_PATH"
            echo "Provisioning profile written without base64 decoding."
          fi

      - name: Archive iOS app
        run: |
          set -o pipefail
          mkdir -p build
          if [ "${{ inputs.perform_signing }}" = "true" ]; then
            xcodebuild \
              -project "$XCODE_PROJECT" \
              -scheme "${{ inputs.scheme }}" \
              -configuration "${{ inputs.configuration }}" \
              -sdk iphoneos \
              -archivePath "build/${{ inputs.scheme }}.xcarchive" \
              DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="${{ inputs.code_sign_identity }}" \
              PROVISIONING_PROFILE_SPECIFIER="${{ inputs.provisioning_profile_name }}" \
              clean archive
          else
            xcodebuild \
              -project "$XCODE_PROJECT" \
              -scheme "${{ inputs.scheme }}" \
              -configuration "${{ inputs.configuration }}" \
              -sdk iphoneos \
              -archivePath "build/${{ inputs.scheme }}.xcarchive" \
              CODE_SIGNING_ALLOWED=NO \
              clean archive
          fi

      - name: Export IPA
        if: inputs.perform_signing == true
        run: |
          set -euo pipefail
          APP_BUNDLE_ID=$(jq -r '.appId' TemplateApp/TemplateApp/Config/app.json)
          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${APP_BUNDLE_ID}</key>
              <string>${{ inputs.provisioning_profile_name }}</string>
            </dict>
          </dict>
          </plist>
          EOF
          xcodebuild \
            -exportArchive \
            -archivePath "build/${{ inputs.scheme }}.xcarchive" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath build/export
          IPA_FILE=$(find build/export -maxdepth 1 -name '*.ipa' | head -n 1 || true)
          if [[ -z "$IPA_FILE" ]]; then
            echo "exportArchive did not produce an .ipa in build/export" >&2
            ls -R build/export || true
            exit 1
          fi
          echo "IPA_PATH=$IPA_FILE" >> "$GITHUB_ENV"

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.scheme }}-build
          path: build

      - name: Upload to TestFlight
        if: inputs.upload_to_testflight == true && inputs.perform_signing == true
        uses: maierj/fastlane-action@v2.1.0
        with:
          lane: upload_testflight
          subdirectory: .
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
